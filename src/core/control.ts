import { emitUIInteraction, responseMap } from '@cve-ts/player'
import type { ResponseData, UIDescriptor } from '@cve-ts/player'

import send from './web-view'

function getUId() {
  const len = 8
  let radix = 16
  const chars =
    '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('')
  const uuid = []
  radix = radix || chars.length

  for (let i = 0; i < len; i++) {
    uuid[i] = chars[0 | (Math.random() * radix)]
  }

  return uuid.join('')
}

export default class CveControl {
  declare timeoutSpan: number

  constructor() {
    this.timeoutSpan = 1000 * 15
  }

  executeCustomCommand(
    Command: string,
    Data: string | undefined,
    callback?: CveCallback
  ) {
    return this.sendCommand({ Command, Data }, (res) => {
      if (typeof callback === 'function') {
        callback(res)
      }
    })
  }

  executeUeCommand(Console: string) {
    return this.sendCommand({ Console })
  }

  getResponse(uid: string, callback?: CveCallback) {
    return new Promise<ResponseData>((resolve: CveResolve) => {
      const response = responseMap.get(uid)!
      const elapsedTime = Date.now() - response.RequestDateTime
      if (response.ResponseData) {
        responseMap.delete(uid)
        if (typeof callback === 'function') {
          callback(response.ResponseData)
          resolve(response.ResponseData)
        }
      } else if (elapsedTime > this.timeoutSpan) {
        responseMap.delete(uid)
        if (typeof callback === 'function') {
          response.ResponseData = {
            Result: 'Timeout',
          }
          callback(response.ResponseData)
          resolve(response.ResponseData)
        }
      } else {
        setTimeout(() => {
          resolve(this.getResponse(uid, callback))
        }, 0)
      }
    })
  }

  sendCommand(descriptor: UIDescriptor, callback?: CveCallback) {
    return new Promise<ResponseData>((resolve: CveResolve, reject: CveResolve) => {
      const player = document.querySelector('cve-player')
      if (window.ue) {
        const key = descriptor.Command ?? descriptor.Console
        if (key) {
          send(key, descriptor, (res) => {
            if (typeof callback === 'function') {
              callback(res)
            }
            resolve(res)
          })
        }
      } else if (player) {
        const uid = getUId()
        descriptor.UID = uid
        responseMap.set(uid, {
          RequestDateTime: Date.now(),
          ResponseData: {},
        })
        emitUIInteraction(descriptor)
        this.getResponse(uid, (res) => {
          if (typeof callback === 'function') {
            callback(res)
          }
          resolve(res)
        })
      } else {
        reject({ Result: '[Error] Failed to get UE host!' })
      }
    })
  }
}

export { CveControl }
